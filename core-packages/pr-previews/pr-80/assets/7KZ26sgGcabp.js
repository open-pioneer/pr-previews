var Et=Object.defineProperty;var it=t=>{throw TypeError(t)};var wt=(t,e,i)=>e in t?Et(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var G=(t,e,i)=>wt(t,typeof e!="symbol"?e+"":e,i),J=(t,e,i)=>e.has(t)||it("Cannot "+i);var n=(t,e,i)=>(J(t,e,"read from private field"),i?i.call(t):e.get(t)),u=(t,e,i)=>e.has(t)?it("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),s=(t,e,i,r)=>(J(t,e,"write to private field"),r?r.call(t,i):e.set(t,i),i),c=(t,e,i)=>(J(t,e,"access private method"),i);import{c as kt,aH as xt,af as At,aI as It,r as v,j as b}from"./Bs9hMHdnnuo8.js";import{u as Ct,a as qt}from"./Bw3hPMsT3dEm.js";import{B as Ft}from"./ponVpkCf_hvV.js";var Rt=Symbol.for("preact-signals");function X(){if(x>1)x--;else{for(var t,e=!1;j!==void 0;){var i=j;for(j=void 0,K++;i!==void 0;){var r=i.o;if(i.o=void 0,i.f&=-3,!(8&i.f)&&ut(i))try{i.c()}catch(h){e||(t=h,e=!0)}i=r}}if(K=0,x--,e)throw t}}var o=void 0;function Z(t){var e=o;o=void 0;try{return t()}finally{o=e}}var j=void 0,x=0,K=0,W=0;function ot(t){if(o!==void 0){var e=t.n;if(e===void 0||e.t!==o)return e={i:0,S:t,p:o.s,n:void 0,t:o,e:void 0,x:void 0,r:e},o.s!==void 0&&(o.s.n=e),o.s=e,t.n=e,32&o.f&&t.S(e),e;if(e.i===-1)return e.i=0,e.n!==void 0&&(e.n.p=e.p,e.p!==void 0&&(e.p.n=e.n),e.p=o.s,e.n=void 0,o.s.n=e,o.s=e),e}}function a(t){this.v=t,this.i=0,this.n=void 0,this.t=void 0}a.prototype.brand=Rt;a.prototype.h=function(){return!0};a.prototype.S=function(t){this.t!==t&&t.e===void 0&&(t.x=this.t,this.t!==void 0&&(this.t.e=t),this.t=t)};a.prototype.U=function(t){if(this.t!==void 0){var e=t.e,i=t.x;e!==void 0&&(e.x=i,t.e=void 0),i!==void 0&&(i.e=e,t.x=void 0),t===this.t&&(this.t=i)}};a.prototype.subscribe=function(t){var e=this;return et(function(){var i=e.value,r=o;o=void 0;try{t(i)}finally{o=r}})};a.prototype.valueOf=function(){return this.value};a.prototype.toString=function(){return this.value+""};a.prototype.toJSON=function(){return this.value};a.prototype.peek=function(){var t=o;o=void 0;try{return this.value}finally{o=t}};Object.defineProperty(a.prototype,"value",{get:function(){var t=ot(this);return t!==void 0&&(t.i=this.i),this.v},set:function(t){if(t!==this.v){if(K>100)throw new Error("Cycle detected");this.v=t,this.i++,W++,x++;try{for(var e=this.t;e!==void 0;e=e.x)e.t.N()}finally{X()}}}});function jt(t){return new a(t)}function ut(t){for(var e=t.s;e!==void 0;e=e.n)if(e.S.i!==e.i||!e.S.h()||e.S.i!==e.i)return!0;return!1}function ht(t){for(var e=t.s;e!==void 0;e=e.n){var i=e.S.n;if(i!==void 0&&(e.r=i),e.S.n=e,e.i=-1,e.n===void 0){t.s=e;break}}}function at(t){for(var e=t.s,i=void 0;e!==void 0;){var r=e.p;e.i===-1?(e.S.U(e),r!==void 0&&(r.n=e.n),e.n!==void 0&&(e.n.p=r)):i=e,e.S.n=e.r,e.r!==void 0&&(e.r=void 0),e=r}t.s=i}function R(t){a.call(this,void 0),this.x=t,this.s=void 0,this.g=W-1,this.f=4}(R.prototype=new a).h=function(){if(this.f&=-3,1&this.f)return!1;if((36&this.f)==32||(this.f&=-5,this.g===W))return!0;if(this.g=W,this.f|=1,this.i>0&&!ut(this))return this.f&=-2,!0;var t=o;try{ht(this),o=this;var e=this.x();(16&this.f||this.v!==e||this.i===0)&&(this.v=e,this.f&=-17,this.i++)}catch(i){this.v=i,this.f|=16,this.i++}return o=t,at(this),this.f&=-2,!0};R.prototype.S=function(t){if(this.t===void 0){this.f|=36;for(var e=this.s;e!==void 0;e=e.n)e.S.S(e)}a.prototype.S.call(this,t)};R.prototype.U=function(t){if(this.t!==void 0&&(a.prototype.U.call(this,t),this.t===void 0)){this.f&=-33;for(var e=this.s;e!==void 0;e=e.n)e.S.U(e)}};R.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var t=this.t;t!==void 0;t=t.x)t.t.N()}};Object.defineProperty(R.prototype,"value",{get:function(){if(1&this.f)throw new Error("Cycle detected");var t=ot(this);if(this.h(),t!==void 0&&(t.i=this.i),16&this.f)throw this.v;return this.v}});function ct(t){return new R(t)}function ft(t){var e=t.u;if(t.u=void 0,typeof e=="function"){x++;var i=o;o=void 0;try{e()}catch(r){throw t.f&=-2,t.f|=8,tt(t),r}finally{o=i,X()}}}function tt(t){for(var e=t.s;e!==void 0;e=e.n)e.S.U(e);t.x=void 0,t.s=void 0,ft(t)}function Nt(t){if(o!==this)throw new Error("Out-of-order effect");at(this),o=t,this.f&=-2,8&this.f&&tt(this),X()}function P(t){this.x=t,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32}P.prototype.c=function(){var t=this.S();try{if(8&this.f||this.x===void 0)return;var e=this.x();typeof e=="function"&&(this.u=e)}finally{t()}};P.prototype.S=function(){if(1&this.f)throw new Error("Cycle detected");this.f|=1,this.f&=-9,ft(this),ht(this),x++;var t=o;return o=this,Nt.bind(this,t)};P.prototype.N=function(){2&this.f||(this.f|=2,this.o=j,j=this)};P.prototype.d=function(){this.f|=8,1&this.f||tt(this)};function et(t){var e=new P(t);try{e.c()}catch(i){throw e.d(),i}return e.d.bind(e)}function Ot(t){let e;return{destroy:et(function(){this[Tt]=t.bind(void 0),e=this[Lt].bind(this)}),start:e}}var Tt="N",Lt="S";function ae(t,e){return new Mt(t,e?.equal)}function Ut(t,e){return new Dt(t,e?.equal)}function lt(t){return Z(t)}var k=Symbol("signal"),N=Symbol("equals"),dt=class{[k];constructor(t){this[k]=t}get value(){return this[k].value}set value(t){throw new Error("Cannot update a readonly reactive object.")}trigger(){throw new Error("Cannot trigger this reactive object.")}peek(){return this[k].peek()}toJSON(){return this.value}toString(){return`Reactive[value=${_t(this[k].value)}]`}},Dt=class extends dt{[N];constructor(t,e){const i=ct(e?Pt(t,e):t);super(i),this[N]=e}},Mt=class extends dt{[N];constructor(t,e){super(jt(t)),this[N]=e}get value(){return super.value}set value(t){Z(()=>this[N]?.(this.value,t))||(this[k].value=t)}};function Pt(t,e){let i=!0,r;return function(){const l=t();return Z(()=>((i||!e(r,l))&&(r=l,i=!1),r))}}function _t(t){return typeof t=="string"?JSON.stringify(t):String(t)}function vt(t,e){return t===e?!0:t.length===e.length&&t.every((i,r)=>i===e[r])}function pt(t,e,i,r){const h=ct(e),l=r?.immediate??!1,bt=r?.equal??Wt;return new Ht(t,i,h,bt,l)}var O,T,L,E,U,A,I,p,S,yt,_,nt,Ht=(nt=class{constructor(t,e,i,r,h){u(this,S);u(this,O);u(this,T);u(this,L);u(this,E,!0);u(this,U);u(this,A);u(this,I,!1);u(this,p);G(this,"destroy",()=>{s(this,I,!0),n(this,p)?.destroy(),s(this,p,void 0),c(this,S,_).call(this)});s(this,O,e),s(this,T,h),s(this,L,r),s(this,p,t(()=>{const l=i.value;lt(()=>{c(this,S,yt).call(this,l)})})),n(this,I)&&(n(this,p).destroy(),s(this,p,void 0))}},O=new WeakMap,T=new WeakMap,L=new WeakMap,E=new WeakMap,U=new WeakMap,A=new WeakMap,I=new WeakMap,p=new WeakMap,S=new WeakSet,yt=function(t){const e=n(this,U),i=n(this,E)&&n(this,T)||!n(this,E)&&!n(this,L).call(this,e,t);if((i||n(this,E))&&(s(this,U,t),s(this,E,!1)),i){c(this,S,_).call(this);const r=n(this,O).call(this,t,e,this);typeof r=="function"&&s(this,A,r)}n(this,I)&&c(this,S,_).call(this)},_=function(){const t=n(this,A);s(this,A,void 0);try{t?.()}catch(e){throw this.destroy(),e}},nt);function Wt(t,e){return t===e}function Bt(t){let e=!1,i;const r={destroy(){e||(e=!0,i?.())}};return i=et(()=>t(r)),e&&i(),r}function $t(t,e,i){return pt(Bt,t,e,{equal:vt,...i})}var Y;typeof globalThis.reportError=="function"?Y=globalThis.reportError:Y=t=>console.error(t);function gt(t){Y(new Error("Error in effect or watch callback",{cause:t}))}var Gt=class{queue=[];channel=new MessageChannel;constructor(){this.channel.port2.start()}enqueue(t){const e={fn:t,destroyed:!1};return this.queue.push(e),this.queue.length===1&&this.scheduleIteration(),{destroy(){e.destroyed||(e.destroyed=!0)}}}messageHandler=()=>this.runIteration();scheduleIteration(){const t=this.channel;t.port2.addEventListener("message",this.messageHandler),t.port1.postMessage("")}runIteration(){this.channel.port2.removeEventListener("message",this.messageHandler);const t=this.queue;this.queue=[];for(const e of t)if(!e.destroyed)try{e.fn()}catch(i){gt(i)}}};function Jt(t){const e=new Qt(t);return{destroy:e.destroy.bind(e)}}var D,C,w,y,g,M,q,f,z,V,H,B,st,Qt=(st=class{constructor(t){u(this,f);u(this,D);u(this,C);u(this,w);u(this,y);u(this,g,!1);u(this,M,!0);u(this,q,!1);G(this,"destroy",()=>{if(!n(this,g)){s(this,g,!0);try{c(this,f,H).call(this)}finally{n(this,w)?.destroy(),s(this,w,void 0),n(this,y)?.destroy(),s(this,y,void 0)}}});u(this,B,()=>{if(!n(this,g)){if(n(this,q))throw new Error("Cycle detected");n(this,y)||s(this,y,zt(()=>{try{c(this,f,z).call(this)}finally{s(this,y,void 0)}}))}});s(this,D,t),s(this,w,Ot(n(this,B))),c(this,f,z).call(this),s(this,M,!1)}},D=new WeakMap,C=new WeakMap,w=new WeakMap,y=new WeakMap,g=new WeakMap,M=new WeakMap,q=new WeakMap,f=new WeakSet,z=function(){const t=n(this,w);if(!t)return;s(this,q,!0);const e=t.start();try{if(n(this,M))try{c(this,f,V).call(this)}catch(i){throw this.destroy(),i}else try{c(this,f,V).call(this)}catch(i){gt(i)}}finally{e(),s(this,q,!1)}n(this,g)&&c(this,f,H).call(this)},V=function(){if(!n(this,g)){c(this,f,H).call(this);const t=n(this,D).call(this,this);typeof t=="function"&&s(this,C,t)}},H=function(){const t=n(this,C);s(this,C,void 0);try{t&&lt(t)}catch(e){throw this.destroy(),e}},B=new WeakMap,st);function Kt(t,e,i){return pt(Jt,t,e,{equal:vt,...i})}var Yt=new Gt;function zt(t){return Yt.enqueue(t)}const Q=kt("authentication:AuthService");var m,d,F,$,mt;class ce{constructor(e){u(this,$);u(this,m);u(this,d);u(this,F);s(this,m,e.references.plugin),s(this,F,$t(()=>[n(this,m).getAuthState()],([i])=>{c(this,$,mt).call(this,i)},{immediate:!1})),Q.debug(`Constructed with initial auth state '${this.getAuthState().kind}'`,this.getAuthState())}destroy(){n(this,d)?.reject(xt()),s(this,d,void 0),s(this,F,At(n(this,F)))}getAuthState(){return n(this,m).getAuthState()}getSessionInfo(){return this.getAuthState().kind!=="pending"?Promise.resolve(rt(this.getAuthState())):(n(this,d)||s(this,d,It()),n(this,d).promise)}getLoginBehavior(){return n(this,m).getLoginBehavior()}logout(){Q.debug("Triggering logout"),n(this,m).logout()}}m=new WeakMap,d=new WeakMap,F=new WeakMap,$=new WeakSet,mt=function(e){e.kind!=="pending"&&n(this,d)&&(n(this,d).resolve(rt(e)),s(this,d,void 0)),Q.debug(`Auth state changed to '${e.kind}'`,e)};function rt(t){return t.kind==="authenticated"?t.sessionInfo:void 0}const St="@open-pioneer/authentication",Vt=Ct.bind(void 0,St),Xt=qt.bind(void 0,St);function Zt(t,e){const i=v.useRef(t);i.current=t;const r=ie(e);return v.useMemo(()=>Ut(()=>i.current()),[r])}function te(t){const e=v.useCallback(()=>t.peek(),[t]),i=v.useCallback(h=>{const l=Kt(()=>[t.value],h);return()=>l.destroy()},[t]),r=v.useSyncExternalStore(i,e);return v.useDebugValue(r),r}function ee(t,e){const i=Zt(t,e),r=te(i);return v.useDebugValue(r),r}function ie(t){const e=v.useRef(null);return(e.current==null||!re(e.current,t))&&(e.current=t??[]),e.current}function re(t,e){return t===e?!0:t.length===(e?.length??0)&&t.every((i,r)=>i===e[r])}function ne(t){return ee(()=>t.getAuthState(),[t])}const fe=t=>{const e=Vt("authentication.AuthService"),i=ne(e),r=Xt(),h=v.useMemo(()=>{if(i.kind==="not-authenticated")return e.getLoginBehavior()},[e,i.kind]);switch(v.useEffect(()=>{i.kind==="not-authenticated"&&h?.kind==="effect"&&h.login()},[h,i.kind]),i.kind){case"pending":return null;case"not-authenticated":{if(!h||h.kind!=="fallback")return null;const l=h.Fallback;return t.renderFallback?b.jsx(b.Fragment,{children:t.renderFallback(l)}):b.jsx(l,{...t.fallbackProps})}case"error":return t.renderErrorFallback?t.renderErrorFallback(i.error):t.errorFallback?b.jsx(t.errorFallback,{error:i.error}):b.jsx(Ft,{className:"authentication-error",children:r.formatMessage({id:"auth-error"})});case"authenticated":return b.jsx(b.Fragment,{children:t.children})}};export{ce as A,fe as F,ae as r,ne as u};
