var mt=Object.defineProperty;var Me=n=>{throw TypeError(n)};var yt=(n,e,t)=>e in n?mt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var f=(n,e,t)=>yt(n,typeof e!="symbol"?e+"":e,t),me=(n,e,t)=>e.has(n)||Me("Cannot "+t);var _=(n,e,t)=>(me(n,e,"read from private field"),t?t.call(n):e.get(n)),v=(n,e,t)=>e.has(n)?Me("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),x=(n,e,t,s)=>(me(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),$=(n,e,t)=>(me(n,e,"access private method"),t);import{b3 as pt,b4 as vt,b5 as St,b6 as xt,b7 as We,b8 as wt,b9 as bt,a as se,b as be,aL as le,ba as Le,bb as j,a9 as Pe,G as L,bc as ye,a_ as z,an as Ie,bd as oe,p as E,be as P,bf as Te,bg as F,bh as ue,bi as Ct,bj as Et,z as Ft,bk as xe,bl as Mt,bm as Lt,bn as ze,ao as Je,bo as Pt,bp as It,bq as ke,br as Tt,bs as Ae,bt as kt,bu as Oe,j as ie,r as Ce,a$ as Ke,bv as Ye,bw as At,bx as Ot,u as Xe,by as Ee,aZ as Ze,i as Qe,f as Dt,bz as De,bA as Rt,bB as Re,k as Ge}from"./CSmiKdizJP8d.js";import{c as fe,d as et,j as y,s as re,C as Gt,v as jt,i as tt,r as p,B as st,w as it,V as Vt,t as Nt,I as Bt}from"./CilY7FyO6Rl3.js";import{G as rt}from"./qJ8eJhSfJf-T.js";import{O as nt}from"./CqnaKyfzTnUa.js";import{a as Ut}from"./Cqi0VnO_D_SD.js";import{D as Ht}from"./KONR8iZ-Avj1.js";import{u as H}from"./hnzQPimfMtwE.js";import{c as k,s as ot,u as $t}from"./BijvRNQYcfni.js";import{c as qt}from"./xdScXFjN6s-F.js";import{F as Wt}from"./n4hly-pWbHU_.js";import{F as zt}from"./BBrt1HOYTwGp.js";import{F as Jt}from"./RthlauyR4DBd.js";const ti=pt,je=0,W=1,Ve=[0,0,0,0],V=[],pe={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"};class ve extends Je{constructor(e,t,s){super(e),this.features=t,this.mapBrowserEvent=s}}class Kt extends vt{constructor(e){super(e),this.on,this.once,this.un,this.boundHandleFeatureChange_=this.handleFeatureChange_.bind(this),this.condition_=e.condition?e.condition:St,this.defaultDeleteCondition_=function(s){return xt(s)&&We(s)},this.deleteCondition_=e.deleteCondition?e.deleteCondition:this.defaultDeleteCondition_,this.insertVertexCondition_=e.insertVertexCondition?e.insertVertexCondition:wt,this.vertexFeature_=null,this.vertexSegments_=null,this.lastPixel_=[0,0],this.ignoreNextSingleClick_=!1,this.featuresBeingModified_=null,this.rBush_=new bt,this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.snappedToVertex_=!1,this.changingFeature_=!1,this.dragSegments_=[],this.overlay_=new se({source:new be({useSpatialIndex:!1,wrapX:!!e.wrapX}),style:e.style?e.style:Xt(),updateWhileAnimating:!0,updateWhileInteracting:!0}),this.SEGMENT_WRITERS_={Point:this.writePointGeometry_.bind(this),LineString:this.writeLineStringGeometry_.bind(this),LinearRing:this.writeLineStringGeometry_.bind(this),Polygon:this.writePolygonGeometry_.bind(this),MultiPoint:this.writeMultiPointGeometry_.bind(this),MultiLineString:this.writeMultiLineStringGeometry_.bind(this),MultiPolygon:this.writeMultiPolygonGeometry_.bind(this),Circle:this.writeCircleGeometry_.bind(this),GeometryCollection:this.writeGeometryCollectionGeometry_.bind(this)},this.source_=null,this.hitDetection_=null;let t;if(e.features?t=e.features:e.source&&(this.source_=e.source,t=new le(this.source_.getFeatures()),this.source_.addEventListener(Le.ADDFEATURE,this.handleSourceAdd_.bind(this)),this.source_.addEventListener(Le.REMOVEFEATURE,this.handleSourceRemove_.bind(this))),!t)throw new Error("The modify interaction requires features, a source or a layer");e.hitDetection&&(this.hitDetection_=e.hitDetection),this.features_=t,this.features_.forEach(this.addFeature_.bind(this)),this.features_.addEventListener(j.ADD,this.handleFeatureAdd_.bind(this)),this.features_.addEventListener(j.REMOVE,this.handleFeatureRemove_.bind(this)),this.lastPointerEvent_=null,this.delta_=[0,0],this.snapToPointer_=e.snapToPointer===void 0?!this.hitDetection_:e.snapToPointer}addFeature_(e){const t=e.getGeometry();if(t){const i=this.SEGMENT_WRITERS_[t.getType()];i&&i(e,t)}const s=this.getMap();s&&s.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(s.getCoordinateFromPixel(this.lastPixel_)),e.addEventListener(Pe.CHANGE,this.boundHandleFeatureChange_)}willModifyFeatures_(e,t){if(!this.featuresBeingModified_){this.featuresBeingModified_=new le;const s=this.featuresBeingModified_.getArray();for(let i=0,r=t.length;i<r;++i){const a=t[i].feature;a&&!s.includes(a)&&this.featuresBeingModified_.push(a)}this.featuresBeingModified_.getLength()===0?this.featuresBeingModified_=null:this.dispatchEvent(new ve(pe.MODIFYSTART,this.featuresBeingModified_,e))}}removeFeature_(e){this.removeFeatureSegmentData_(e),this.vertexFeature_&&this.features_.getLength()===0&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.removeEventListener(Pe.CHANGE,this.boundHandleFeatureChange_)}removeFeatureSegmentData_(e){const t=this.rBush_,s=[];t.forEach(function(i){e===i.feature&&s.push(i)});for(let i=s.length-1;i>=0;--i){const r=s[i];for(let a=this.dragSegments_.length-1;a>=0;--a)this.dragSegments_[a][0]===r&&this.dragSegments_.splice(a,1);t.remove(r)}}setActive(e){this.vertexFeature_&&!e&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),super.setActive(e)}setMap(e){this.overlay_.setMap(e),super.setMap(e)}getOverlay(){return this.overlay_}handleSourceAdd_(e){e.feature&&this.features_.push(e.feature)}handleSourceRemove_(e){e.feature&&this.features_.remove(e.feature)}handleFeatureAdd_(e){this.addFeature_(e.element)}handleFeatureChange_(e){if(!this.changingFeature_){const t=e.target;this.removeFeature_(t),this.addFeature_(t)}}handleFeatureRemove_(e){this.removeFeature_(e.element)}writePointGeometry_(e,t){const s=t.getCoordinates(),i={feature:e,geometry:t,segment:[s,s]};this.rBush_.insert(t.getExtent(),i)}writeMultiPointGeometry_(e,t){const s=t.getCoordinates();for(let i=0,r=s.length;i<r;++i){const a=s[i],o={feature:e,geometry:t,depth:[i],index:i,segment:[a,a]};this.rBush_.insert(t.getExtent(),o)}}writeLineStringGeometry_(e,t){const s=t.getCoordinates();for(let i=0,r=s.length-1;i<r;++i){const a=s.slice(i,i+2),o={feature:e,geometry:t,index:i,segment:a};this.rBush_.insert(L(a),o)}}writeMultiLineStringGeometry_(e,t){const s=t.getCoordinates();for(let i=0,r=s.length;i<r;++i){const a=s[i];for(let o=0,c=a.length-1;o<c;++o){const u=a.slice(o,o+2),l={feature:e,geometry:t,depth:[i],index:o,segment:u};this.rBush_.insert(L(u),l)}}}writePolygonGeometry_(e,t){const s=t.getCoordinates();for(let i=0,r=s.length;i<r;++i){const a=s[i];for(let o=0,c=a.length-1;o<c;++o){const u=a.slice(o,o+2),l={feature:e,geometry:t,depth:[i],index:o,segment:u};this.rBush_.insert(L(u),l)}}}writeMultiPolygonGeometry_(e,t){const s=t.getCoordinates();for(let i=0,r=s.length;i<r;++i){const a=s[i];for(let o=0,c=a.length;o<c;++o){const u=a[o];for(let l=0,g=u.length-1;l<g;++l){const h=u.slice(l,l+2),d={feature:e,geometry:t,depth:[o,i],index:l,segment:h};this.rBush_.insert(L(h),d)}}}}writeCircleGeometry_(e,t){const s=t.getCenter(),i={feature:e,geometry:t,index:je,segment:[s,s]},r={feature:e,geometry:t,index:W,segment:[s,s]},a=[i,r];i.featureSegments=a,r.featureSegments=a,this.rBush_.insert(ye(s),i);let o=t;this.rBush_.insert(o.getExtent(),r)}writeGeometryCollectionGeometry_(e,t){const s=t.getGeometriesArray();for(let i=0;i<s.length;++i){const r=s[i],a=this.SEGMENT_WRITERS_[r.getType()];a(e,r)}}createOrUpdateVertexFeature_(e,t,s,i){let r=this.vertexFeature_;return r?r.getGeometry().setCoordinates(e):(r=new z(new Ie(e)),this.vertexFeature_=r,this.overlay_.getSource().addFeature(r)),r.set("features",t),r.set("geometries",s),r.set("existing",i),r}handleEvent(e){if(!e.originalEvent)return!0;this.lastPointerEvent_=e;let t;return!e.map.getView().getInteracting()&&e.type==oe.POINTERMOVE&&!this.handlingDownUpSequence&&this.handlePointerMove_(e),this.vertexFeature_&&this.deleteCondition_(e)&&(e.type!=oe.SINGLECLICK||!this.ignoreNextSingleClick_?t=this.removePoint():t=!0),e.type==oe.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),super.handleEvent(e)&&!t}findInsertVerticesAndUpdateDragSegments_(e){this.handlePointerAtPixel_(e),this.dragSegments_.length=0,this.featuresBeingModified_=null;const t=this.vertexFeature_;if(!t)return;this.getMap().getView().getProjection();const s=[],i=t.getGeometry().getCoordinates(),r=L([i]),a=this.rBush_.getInExtent(r),o={};a.sort(Yt);for(let c=0,u=a.length;c<u;++c){const l=a[c],g=l.segment;let h=E(l.geometry);const d=l.depth;if(d&&(h+="-"+d.join("-")),o[h]||(o[h]=new Array(2)),l.geometry.getType()==="Circle"&&l.index===W){const m=Be(e,l);P(m,i)&&!o[h][0]&&(this.dragSegments_.push([l,0]),o[h][0]=l);continue}if(P(g[0],i)&&!o[h][0]){this.dragSegments_.push([l,0]),o[h][0]=l;continue}if(P(g[1],i)&&!o[h][1]){if(o[h][0]&&o[h][0].index===0){let m=l.geometry.getCoordinates();switch(l.geometry.getType()){case"LineString":case"MultiLineString":continue;case"MultiPolygon":m=m[d[1]];case"Polygon":if(l.index!==m[d[0]].length-2)continue;break}}this.dragSegments_.push([l,1]),o[h][1]=l;continue}E(g)in this.vertexSegments_&&!o[h][0]&&!o[h][1]&&s.push(l)}return s}handleDragEvent(e){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(e,this.dragSegments_.map(([r])=>r));const t=[e.coordinate[0]+this.delta_[0],e.coordinate[1]+this.delta_[1]],s=[],i=[];for(let r=0,a=this.dragSegments_.length;r<a;++r){const o=this.dragSegments_[r],c=o[0],u=c.feature;s.includes(u)||s.push(u);const l=c.geometry;i.includes(l)||i.push(l);const g=c.depth;let h;const d=c.segment,m=o[1];for(;t.length<l.getStride();)t.push(d[m][t.length]);switch(l.getType()){case"Point":h=t,d[0]=t,d[1]=t;break;case"MultiPoint":h=l.getCoordinates(),h[c.index]=t,d[0]=t,d[1]=t;break;case"LineString":h=l.getCoordinates(),h[c.index+m]=t,d[m]=t;break;case"MultiLineString":h=l.getCoordinates(),h[g[0]][c.index+m]=t,d[m]=t;break;case"Polygon":h=l.getCoordinates(),h[g[0]][c.index+m]=t,d[m]=t;break;case"MultiPolygon":h=l.getCoordinates(),h[g[1]][g[0]][c.index+m]=t,d[m]=t;break;case"Circle":const w=l;if(d[0]=t,d[1]=t,c.index===je)this.changingFeature_=!0,w.setCenter(t),this.changingFeature_=!1;else{this.changingFeature_=!0,e.map.getView().getProjection();let M=Te(F(w.getCenter()),F(t));w.setRadius(M),this.changingFeature_=!1}break}h&&this.setGeometryCoordinates_(l,h)}this.createOrUpdateVertexFeature_(t,s,i,!0)}handleDownEvent(e){if(!this.condition_(e))return!1;const t=e.coordinate,s=this.findInsertVerticesAndUpdateDragSegments_(t);if(s?.length&&this.insertVertexCondition_(e)&&(this.willModifyFeatures_(e,s),this.vertexFeature_)){const i=this.vertexFeature_.getGeometry().getCoordinates();for(let r=s.length-1;r>=0;--r)this.insertVertex_(s[r],i);this.ignoreNextSingleClick_=!0}return!!this.vertexFeature_}handleUpEvent(e){for(let t=this.dragSegments_.length-1;t>=0;--t){const s=this.dragSegments_[t][0],i=s.geometry;if(i.getType()==="Circle"){const r=i,a=r.getCenter(),o=s.featureSegments[0],c=s.featureSegments[1];o.segment[0]=a,o.segment[1]=a,c.segment[0]=a,c.segment[1]=a,this.rBush_.update(ye(a),o);let u=r;this.rBush_.update(u.getExtent(),c)}else this.rBush_.update(L(s.segment),s)}return this.featuresBeingModified_&&(this.dispatchEvent(new ve(pe.MODIFYEND,this.featuresBeingModified_,e)),this.featuresBeingModified_=null),!1}handlePointerMove_(e){this.lastPixel_=e.pixel,this.handlePointerAtPixel_(e.coordinate)}handlePointerAtPixel_(e){const t=this.getMap(),s=t.getPixelFromCoordinate(e);t.getView().getProjection();const i=function(o,c){return Ne(e,o)-Ne(e,c)};let r,a;if(this.hitDetection_){const o=typeof this.hitDetection_=="object"?c=>c===this.hitDetection_:void 0;t.forEachFeatureAtPixel(s,(c,u,l)=>{l&&l.getType()==="Point"&&(l=new Ie(ue(l.getCoordinates())));const g=l||c.getGeometry();if(g&&g.getType()==="Point"&&c instanceof z&&this.features_.getArray().includes(c)){a=g;const h=c.getGeometry().getFlatCoordinates().slice(0,2);r=[{feature:c,geometry:a,segment:[h,h]}]}return!0},{layerFilter:o})}if(!r){const o=Ct(ye(e,Ve)),c=t.getView().getResolution()*this.pixelTolerance_,u=Et(Ft(o,c,Ve));r=this.rBush_.getInExtent(u)}if(r&&r.length>0){const o=r.sort(i)[0],c=o.segment;let u=Be(e,o);const l=t.getPixelFromCoordinate(u);let g=Te(s,l);if(a||g<=this.pixelTolerance_){const h={};if(h[E(c)]=!0,this.snapToPointer_||(this.delta_[0]=u[0]-e[0],this.delta_[1]=u[1]-e[1]),o.geometry.getType()==="Circle"&&o.index===W)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(u,[o.feature],[o.geometry],this.snappedToVertex_);else{const d=t.getPixelFromCoordinate(c[0]),m=t.getPixelFromCoordinate(c[1]),w=xe(l,d),M=xe(l,m);g=Math.sqrt(Math.min(w,M)),this.snappedToVertex_=g<=this.pixelTolerance_,this.snappedToVertex_&&(u=w>M?c[1]:c[0]),this.createOrUpdateVertexFeature_(u,[o.feature],[o.geometry],this.snappedToVertex_);const R={};R[E(o.geometry)]=!0;for(let O=1,S=r.length;O<S;++O){const b=r[O].segment;if(P(c[0],b[0])&&P(c[1],b[1])||P(c[0],b[1])&&P(c[1],b[0])){const C=E(r[O].geometry);C in R||(R[C]=!0,h[E(b)]=!0)}else break}}this.vertexSegments_=h;return}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}insertVertex_(e,t){const s=e.segment,i=e.feature,r=e.geometry,a=e.depth,o=e.index;let c;for(;t.length<r.getStride();)t.push(0);switch(r.getType()){case"MultiLineString":c=r.getCoordinates(),c[a[0]].splice(o+1,0,t);break;case"Polygon":c=r.getCoordinates(),c[a[0]].splice(o+1,0,t);break;case"MultiPolygon":c=r.getCoordinates(),c[a[1]][a[0]].splice(o+1,0,t);break;case"LineString":c=r.getCoordinates(),c.splice(o+1,0,t);break;default:return!1}this.setGeometryCoordinates_(r,c);const u=this.rBush_;u.remove(e),this.updateSegmentIndices_(r,o,a,1);const l={segment:[s[0],t],feature:i,geometry:r,depth:a,index:o};u.insert(L(l.segment),l),this.dragSegments_.push([l,1]);const g={segment:[t,s[1]],feature:i,geometry:r,depth:a,index:o+1};return u.insert(L(g.segment),g),this.dragSegments_.push([g,0]),!0}updatePointer_(e){return e&&this.findInsertVerticesAndUpdateDragSegments_(e),this.vertexFeature_?.getGeometry().getCoordinates()}getPoint(){const e=this.vertexFeature_?.getGeometry().getCoordinates();return e?ue(e,this.getMap().getView().getProjection()):null}canRemovePoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(L([e])).some(({segment:s})=>P(s[0],e)||P(s[1],e))}removePoint(e){if(e&&(e=F(e,this.getMap().getView().getProjection()),this.updatePointer_(e)),!this.lastPointerEvent_||this.lastPointerEvent_&&this.lastPointerEvent_.type!=oe.POINTERDRAG){const t=this.lastPointerEvent_;this.willModifyFeatures_(t,this.dragSegments_.map(([i])=>i));const s=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new ve(pe.MODIFYEND,this.featuresBeingModified_,t)),this.featuresBeingModified_=null,s}return!1}removeVertex_(){const e=this.dragSegments_,t={};let s=!1,i,r,a,o,c,u,l,g,h,d,m;for(c=e.length-1;c>=0;--c)a=e[c],d=a[0],m=E(d.feature),d.depth&&(m+="-"+d.depth.join("-")),m in t||(t[m]={}),a[1]===0?(t[m].right=d,t[m].index=d.index):a[1]==1&&(t[m].left=d,t[m].index=d.index+1);for(m in t){switch(h=t[m].right,l=t[m].left,u=t[m].index,g=u-1,l!==void 0?d=l:d=h,g<0&&(g=0),o=d.geometry,r=o.getCoordinates(),i=r,s=!1,o.getType()){case"MultiLineString":r[d.depth[0]].length>2&&(r[d.depth[0]].splice(u,1),s=!0);break;case"LineString":r.length>2&&(r.splice(u,1),s=!0);break;case"MultiPolygon":i=i[d.depth[1]];case"Polygon":i=i[d.depth[0]],i.length>4&&(u==i.length-1&&(u=0),i.splice(u,1),s=!0,u===0&&(i.pop(),i.push(i[0]),g=i.length-1));break}if(s){this.setGeometryCoordinates_(o,r);const w=[];if(l!==void 0&&(this.rBush_.remove(l),w.push(l.segment[0])),h!==void 0&&(this.rBush_.remove(h),w.push(h.segment[1])),l!==void 0&&h!==void 0){const M={depth:d.depth,feature:d.feature,geometry:d.geometry,index:g,segment:w};this.rBush_.insert(L(M.segment),M)}this.updateSegmentIndices_(o,u,d.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.length=0}}return s}canInsertPoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(L([e])).some(({segment:s})=>!(P(s[0],e)||P(s[1],e)))}insertPoint(e){const t=e?F(e,this.getMap().getView().getProjection()):this.vertexFeature_?.getGeometry().getCoordinates();return t?this.findInsertVerticesAndUpdateDragSegments_(t).reduce((i,r)=>i||this.insertVertex_(r,t),!1):!1}setGeometryCoordinates_(e,t){this.changingFeature_=!0,e.setCoordinates(t),this.changingFeature_=!1}updateSegmentIndices_(e,t,s,i){this.rBush_.forEachInExtent(e.getExtent(),function(r){r.geometry===e&&(s===void 0||r.depth===void 0||Mt(r.depth,s))&&r.index>t&&(r.index+=i)})}}function Yt(n,e){return n.index-e.index}function Ne(n,e,t){const s=e.geometry;if(s.getType()==="Circle"){let r=s;if(e.index===W){const a=xe(r.getCenter(),F(n)),o=Math.sqrt(a)-r.getRadius();return o*o}}const i=F(n);return V[0]=F(e.segment[0]),V[1]=F(e.segment[1]),Pt(i,V)}function Be(n,e,t){const s=e.geometry;if(s.getType()==="Circle"&&e.index===W)return ue(s.getClosestPoint(F(n)));const i=F(n);return V[0]=F(e.segment[0]),V[1]=F(e.segment[1]),ue(Lt(i,V))}function Xt(){const n=ze();return function(e,t){return n.Point}}const Zt={SELECT:"select"};class Qt extends Je{constructor(e,t,s,i){super(e),this.selected=t,this.deselected=s,this.mapBrowserEvent=i}}const ae={};class at extends It{constructor(e){super(),this.on,this.once,this.un,e=e||{},this.boundAddFeature_=this.addFeature_.bind(this),this.boundRemoveFeature_=this.removeFeature_.bind(this),this.condition_=e.condition?e.condition:We,this.addCondition_=e.addCondition?e.addCondition:ke,this.removeCondition_=e.removeCondition?e.removeCondition:ke,this.toggleCondition_=e.toggleCondition?e.toggleCondition:Tt,this.multi_=e.multi?e.multi:!1,this.filter_=e.filter?e.filter:Ae,this.hitTolerance_=e.hitTolerance?e.hitTolerance:0,this.style_=e.style!==void 0?e.style:es(),this.features_=e.features||new le;let t;if(e.layers)if(typeof e.layers=="function")t=e.layers;else{const s=e.layers;t=function(i){return s.includes(i)}}else t=Ae;this.layerFilter_=t,this.featureLayerAssociation_={}}addFeatureLayerAssociation_(e,t){this.featureLayerAssociation_[E(e)]=t}getFeatures(){return this.features_}getHitTolerance(){return this.hitTolerance_}getLayer(e){return this.featureLayerAssociation_[E(e)]}setHitTolerance(e){this.hitTolerance_=e}setMap(e){this.getMap()&&this.style_&&this.features_.forEach(this.restorePreviousStyle_.bind(this)),super.setMap(e),e?(this.features_.addEventListener(j.ADD,this.boundAddFeature_),this.features_.addEventListener(j.REMOVE,this.boundRemoveFeature_),this.style_&&this.features_.forEach(this.applySelectedStyle_.bind(this))):(this.features_.removeEventListener(j.ADD,this.boundAddFeature_),this.features_.removeEventListener(j.REMOVE,this.boundRemoveFeature_))}addFeature_(e){const t=e.element;if(this.style_&&this.applySelectedStyle_(t),!this.getLayer(t)){const s=this.getMap().getAllLayers().find(function(i){if(i instanceof se&&i.getSource()&&i.getSource().hasFeature(t))return i});s&&this.addFeatureLayerAssociation_(t,s)}}removeFeature_(e){this.style_&&this.restorePreviousStyle_(e.element)}getStyle(){return this.style_}applySelectedStyle_(e){const t=E(e);t in ae||(ae[t]=e.getStyle()),e.setStyle(this.style_)}restorePreviousStyle_(e){const t=this.getMap().getInteractions().getArray();for(let i=t.length-1;i>=0;--i){const r=t[i];if(r!==this&&r instanceof at&&r.getStyle()&&r.getFeatures().getArray().lastIndexOf(e)!==-1){e.setStyle(r.getStyle());return}}const s=E(e);e.setStyle(ae[s]),delete ae[s]}removeFeatureLayerAssociation_(e){delete this.featureLayerAssociation_[E(e)]}handleEvent(e){if(!this.condition_(e))return!0;const t=this.addCondition_(e),s=this.removeCondition_(e),i=this.toggleCondition_(e),r=!t&&!s&&!i,a=e.map,o=this.getFeatures(),c=[],u=[];if(r){kt(this.featureLayerAssociation_),a.forEachFeatureAtPixel(e.pixel,(l,g)=>{if(!(!(l instanceof z)||!this.filter_(l,g)))return this.addFeatureLayerAssociation_(l,g),u.push(l),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let l=o.getLength()-1;l>=0;--l){const g=o.item(l),h=u.indexOf(g);h>-1?u.splice(h,1):(o.remove(g),c.push(g))}u.length!==0&&o.extend(u)}else{a.forEachFeatureAtPixel(e.pixel,(l,g)=>{if(!(!(l instanceof z)||!this.filter_(l,g)))return(t||i)&&!o.getArray().includes(l)?(this.addFeatureLayerAssociation_(l,g),u.push(l)):(s||i)&&o.getArray().includes(l)&&(c.push(l),this.removeFeatureLayerAssociation_(l)),!this.multi_},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_});for(let l=c.length-1;l>=0;--l)o.remove(c[l]);o.extend(u)}return(u.length>0||c.length>0)&&this.dispatchEvent(new Qt(Zt.SELECT,u,c,e)),!0}}function es(){const n=ze();return Oe(n.Polygon,n.LineString),Oe(n.GeometryCollection,n.LineString),function(e){return e.getGeometry()?n[e.getGeometry().getType()]:null}}async function ts(n,e,t,s){const r=s.getCode().replace("EPSG:","http://www.opengis.net/def/crs/EPSG/0/"),a=await n.fetch(e,{method:"POST",body:JSON.stringify({type:"Feature",properties:{},geometry:t}),headers:{"Content-Type":"application/geo+json; charset=utf-8","Content-Crs":`<${r}>`}});if(!a||!a.ok||a.status!==201)throw new Error("Request failed: "+a.status);const o=a.headers.get("location");if(!o)throw new Error("Request failed: no Location response header");const c=o.substring(o.lastIndexOf("/")+1);return Promise.resolve(c)}async function ss(n,e,t,s,i){const a=i.getCode().replace("EPSG:","http://www.opengis.net/def/crs/EPSG/0/"),o=new URL(`${e.toString()}/${t}`),c=await n.fetch(o,{method:"PATCH",body:JSON.stringify({type:"Feature",properties:{},geometry:s}),headers:{"Content-Type":"application/geo+json; charset=utf-8","Content-Crs":`<${a}>`}});if(!c||!c.ok||c.status!==204)throw new Error("Request failed: "+c.status);return Promise.resolve(t)}function ct(n,e){const t=document.createElement("div");t.className="editing-tooltip editing-tooltip-hidden",t.role="tooltip";const s=document.createElement("span");s.textContent=e,t.appendChild(s);const i=new nt({element:t,offset:[15,0],positioning:"center-left"}),r=n.on("pointermove",a=>{a.dragging||i.setPosition(a.coordinate)});return n.addOverlay(i),{destroy(){ie(r),n.removeOverlay(i)},setVisible(a){t.classList.toggle("editing-tooltip-hidden",!a)},setText(a){s.textContent=a}}}function lt(n){let e=Ue(n.polygon);Array.isArray(e)&&(e=e[0]);let t=Ue(n.vertex);Array.isArray(t)&&(t=t[0]);const s=[];return e&&s.push(e),t&&(t.setGeometry(is),s.push(t)),s}const is=n=>{if(n){const e=n.getGeometry();if(e&&e.getType()==="Polygon"){const t=e.getCoordinates()[0];if(t)return new Ut(t)}}},Ue=n=>{const e=new z,s=new se({style:n}).getStyleFunction();if(!s)throw new Error("can't retrieve style function");const i=s(e,1);if(!i)throw new Error("can't retrieve styles from feature style function");return Array.isArray(i)&&i.length?i.length>1?i:i[0]:i},rs=fe("editing:EditingCreateWorkflowImpl");var A;class ns{constructor(e){v(this,A);f(this,"_httpService");f(this,"_intl");f(this,"_map");f(this,"_polygonStyle");f(this,"_vertexStyle");f(this,"_state");f(this,"_editLayerURL");f(this,"_featureId");f(this,"_editingSource");f(this,"_editingLayer");f(this,"_drawInteraction");f(this,"_olMap");f(this,"_tooltip");f(this,"_enterHandler");f(this,"_escapeHandler");f(this,"_error");f(this,"_interactionListener");f(this,"_mapListener");this._httpService=e.httpService,this._intl=e.intl,this._polygonStyle=e.polygonStyle,this._vertexStyle=e.vertexStyle,this._map=e.map,this._olMap=e.map.olMap,this._state=Ce("active:initialized"),this._editLayerURL=e.ogcApiFeatureLayerUrl,this._editingSource=new be,this._editingLayer=new se({source:this._editingSource,zIndex:Ke,properties:{name:"editing-layer"}}),this._drawInteraction=new Ht({source:this._editingSource,type:"Polygon",style:lt({polygon:this._polygonStyle,vertex:this._vertexStyle})}),this._tooltip=ct(this._olMap,this._intl.formatMessage({id:"create.tooltip.begin"})),this._enterHandler=t=>{if((t.code==="Enter"||t.code==="NumpadEnter")&&t.target===this._olMap.getTargetElement()){const s=this._drawInteraction.getOverlay().getSource()?.getFeatures()??[];s[0]&&s[0].getGeometry().getCoordinates()[0].length>4&&this.triggerSave()}},this._escapeHandler=t=>{t.code==="Escape"&&t.target===this._olMap.getTargetElement()&&this.reset()},this._interactionListener=[],this._mapListener=[],this._start()}getDrawInteraction(){return this._drawInteraction}getState(){return this._state.value}_setState(e){this._state.value=e}_save(e){this._setState("active:saving");const t=this._editLayerURL,s=e.getGeometry();if(!s){this._destroy(),this._error=new Error("no geometry available"),_(this,A)?.reject(this._error);return}const i=this._olMap.getView().getProjection(),a=new rt({dataProjection:i}).writeGeometryObject(s,{rightHanded:!0,decimals:10});this._olMap.removeInteraction(this._drawInteraction),this._tooltip.destroy(),ts(this._httpService,t,a,i).then(o=>{this._featureId=o,this._destroy(),_(this,A)?.resolve({featureId:this._featureId})}).catch(o=>{rs.error(o),this._destroy(),this._error=new Error("Failed to save feature",{cause:o}),_(this,A)?.reject(this._error)})}_start(){this._olMap.addLayer(this._editingLayer),this._olMap.addInteraction(this._drawInteraction);const e=Ye(()=>{const i=this._map.container;if(i)return i.addEventListener("keydown",this._enterHandler,!1),i.addEventListener("keydown",this._escapeHandler,!1),()=>{i.removeEventListener("keydown",this._enterHandler),i.removeEventListener("keydown",this._escapeHandler)}});this._tooltip.setVisible(!0);const t=this._drawInteraction.on("drawstart",()=>{this._setState("active:drawing"),this._tooltip.setText(this._intl.formatMessage({id:"create.tooltip.continue"}))}),s=this._drawInteraction.on("drawend",i=>{const r=i.feature;if(!r){this._destroy(),this._error=new Error("no feature available"),_(this,A)?.reject(this._error);return}this._save(r)});this._interactionListener.push(t,s),this._mapListener.push(e)}reset(){this._drawInteraction.abortDrawing(),this._tooltip.setText(this._intl.formatMessage({id:"create.tooltip.begin"})),this._setState("active:initialized")}stop(){this._destroy(),_(this,A)?.resolve(void 0)}_destroy(){this._olMap.removeLayer(this._editingLayer),this._olMap.removeInteraction(this._drawInteraction),this._tooltip.destroy(),this._interactionListener.forEach(e=>{ie(e)}),this._mapListener.forEach(e=>{e.destroy()}),this._setState("destroyed")}triggerSave(){this._drawInteraction.finishDrawing()}whenComplete(){return this._state.value==="destroyed"?this._error?Promise.reject(this._error):this._featureId?Promise.resolve({featureId:this._featureId}):Promise.resolve(void 0):(_(this,A)??x(this,A,et())).promise}}A=new WeakMap;var I;class os{constructor(e){v(this,I);f(this,"_httpService");f(this,"_intl");f(this,"_map");f(this,"_polygonStyle");f(this,"_vertexStyle");f(this,"_state");f(this,"_editLayerURL");f(this,"_featureId");f(this,"_initialFeature");f(this,"_editFeature");f(this,"_editingSource");f(this,"_editingLayer");f(this,"_modifyInteraction");f(this,"_olMap");f(this,"_tooltip");f(this,"_enterHandler");f(this,"_escapeHandler");f(this,"_error");f(this,"_interactionListener");f(this,"_mapListener");this._httpService=e.httpService,this._intl=e.intl,this._polygonStyle=e.polygonStyle,this._vertexStyle=e.vertexStyle,this._map=e.map,this._olMap=e.map.olMap,this._state=Ce("active:initialized"),this._editLayerURL=e.ogcApiFeatureLayerUrl,this._initialFeature=e.feature.clone(),this._initialFeature.setId(e.feature.getId()),this._editFeature=e.feature.clone(),this._editFeature.setId(e.feature.getId()),this._editFeature.setStyle(lt({polygon:this._polygonStyle,vertex:this._vertexStyle})),this._editingSource=new be({features:new le([this._editFeature])}),this._editingLayer=new se({source:this._editingSource,zIndex:Ke,properties:{name:"editing-layer"}}),this._modifyInteraction=new Kt({source:this._editingSource}),this._tooltip=ct(this._olMap,this._intl.formatMessage({id:"create.tooltip.deselect"})),this._enterHandler=t=>{if((t.code==="Enter"||t.code==="NumpadEnter")&&t.target===this._olMap.getTargetElement()){const s=this._editingSource.getFeatures()[0];if(!s)throw Error("no updated feature found");this._save(s)}},this._escapeHandler=t=>{t.code==="Escape"&&t.target===this._olMap.getTargetElement()&&this.reset()},this._interactionListener=[],this._mapListener=[],this._start()}getModifyInteraction(){return this._modifyInteraction}getState(){return this._state.value}_setState(e){this._state.value=e}_save(e){this._setState("active:saving");const t=this._editLayerURL;if(this._featureId=e.getId()?.toString(),!this._featureId){this._destroy(),this._error=new Error("no feature id available"),_(this,I)?.reject(this._error);return}const s=e?.getGeometry();if(!s){this._destroy(),this._error=new Error("no geometry available"),_(this,I)?.reject(this._error);return}const i=this._olMap.getView().getProjection(),a=new rt({dataProjection:i}).writeGeometryObject(s,{rightHanded:!0,decimals:10});this._olMap.removeInteraction(this._modifyInteraction),this._tooltip.destroy(),ss(this._httpService,t,this._featureId,a,i).then(o=>{this._destroy(),_(this,I)?.resolve({featureId:o})}).catch(o=>{this._destroy(),this._error=new Error("Failed to save feature",{cause:o}),_(this,I)?.reject(this._error)})}_start(){this._olMap.addLayer(this._editingLayer),this._olMap.addInteraction(this._modifyInteraction);const e=this._editingSource.getFeatures()[0];if(e&&!e.getId()?.toString()){this._destroy(),this._error=new Error("no feature id available"),_(this,I)?.reject(this._error);return}const t=Ye(()=>{const r=this._map.container;if(r)return r.addEventListener("keydown",this._enterHandler,!1),r.addEventListener("keydown",this._escapeHandler,!1),()=>{r.removeEventListener("keydown",this._enterHandler),r.removeEventListener("keydown",this._escapeHandler)}});this._tooltip.setVisible(!0);const s=this._map.olMap.on("click",r=>{const a=r.coordinate,o=r.originalEvent.altKey,c=this._editingSource.getFeaturesAtCoordinate(a);o||c.length===0&&this.triggerSave()}),i=this._modifyInteraction.on("modifystart",()=>{this._setState("active:drawing")});this._interactionListener.push(s,i),this._mapListener.push(t)}reset(){const e=this._initialFeature.getGeometry()?.clone(),t=this._editingSource.getFeatures()[0];if(!t)throw Error("no updated feature found");t.setGeometry(e),this._setState("active:initialized")}stop(){this._destroy(),_(this,I)?.resolve(void 0)}_destroy(){this._editingSource.clear(),this._olMap.removeLayer(this._editingLayer),this._olMap.removeInteraction(this._modifyInteraction),this._tooltip.destroy(),this._interactionListener.forEach(e=>{ie(e)}),this._mapListener.forEach(e=>{e.destroy()}),this._setState("destroyed")}triggerSave(){const e=this._editingSource.getFeatures()[0];if(!e)throw Error("no updated feature found");this._save(e)}whenComplete(){return this._state.value==="destroyed"?this._error?Promise.reject(this._error):this._featureId?Promise.resolve({featureId:this._featureId}):Promise.resolve(void 0):(_(this,I)??x(this,I,et())).promise}}I=new WeakMap;class si{_serviceOptions;_workflows;constructor(e){this._serviceOptions=e,this._workflows=new Map}createFeature(e,t){if(!t||!e||!e.id)throw new Error("Map, mapId or url is undefined.");const s=e.id;let i=this._workflows.get(s);if(i)throw new Error("EditingWorkflow could not be started. EditingWorkflow already in progress for this map.");return i=new ns({map:e,ogcApiFeatureLayerUrl:t,polygonStyle:this._serviceOptions.properties.polygonStyle,vertexStyle:this._serviceOptions.properties.vertexStyle,httpService:this._serviceOptions.references.httpService,intl:this._serviceOptions.intl}),this._workflows.set(s,i),this._connectToWorkflowDestroyEvent(i,s),i}updateFeature(e,t,s){if(!t||!e||!e.id)throw new Error("Map, mapId or url is undefined.");const i=e.id;let r=this._workflows.get(i);if(r)throw new Error("EditingWorkflow could not be started. EditingWorkflow already in progress for this map.");return r=new os({map:e,ogcApiFeatureLayerUrl:t,feature:s,polygonStyle:this._serviceOptions.properties.polygonStyle,vertexStyle:this._serviceOptions.properties.vertexStyle,httpService:this._serviceOptions.references.httpService,intl:this._serviceOptions.intl}),this._workflows.set(i,r),this._connectToWorkflowDestroyEvent(r,i),r}stop(e){const t=this._workflows.get(e);t&&t.stop()}reset(e){const t=this._workflows.get(e);if(t)t.reset();else throw new Error("No workflow found for mapId: "+e)}_connectToWorkflowDestroyEvent(e,t){const s=At(()=>[e.getState()],([i])=>{i==="destroyed"&&(this._workflows.get(t)===e&&this._workflows.delete(t),s.destroy())})}}var G,D,J,K,Y,we;class as{constructor(e,t,s){v(this,Y);f(this,"label");v(this,G,Ce({kind:"available"}));v(this,D);v(this,J);v(this,K);this.label=t,x(this,D,e),x(this,K,s),$(this,Y,we).call(this),x(this,J,_(this,D).on("change:visible",()=>{$(this,Y,we).call(this)}))}destroy(){ie(_(this,J))}get status(){return _(this,G).value}async select(e,t){if(e.type!=="extent")throw new Error(`Unsupported selection kind: ${e.type}`);if(_(this,G).value.kind!=="available"||_(this,D).getSource()===null)return[];const s=[];_(this,D).getSource().forEachFeatureIntersectingExtent(e.extent,a=>{if(!a.getGeometry())return;const o={...a.getProperties()};delete o.geometries;const c={id:a.getId()?.toString()||Ot(),geometry:a.getGeometry(),properties:o};s.push(c)});const i=s.filter(a=>a!=null);return i.length>t.maxResults?i.slice(0,t.maxResults):i}}G=new WeakMap,D=new WeakMap,J=new WeakMap,K=new WeakMap,Y=new WeakSet,we=function(){const t=_(this,D).getVisible()?{kind:"available"}:{kind:"unavailable",reason:_(this,K)};t.kind!==_(this,G).value.kind&&(_(this,G).value=t)};var X;class ii{constructor({intl:e}){v(this,X);x(this,X,e)}createSelectionSource(e){return new as(e.vectorLayer,e.label,_(this,X).formatMessage({id:"layerNotVisibleReason"}))}}X=new WeakMap;const cs=qt({d:"M23.384,21.619,16.855,15.09a9.284,9.284,0,1,0-1.768,1.768l6.529,6.529a1.266,1.266,0,0,0,1.768,0A1.251,1.251,0,0,0,23.384,21.619ZM2.75,9.5a6.75,6.75,0,1,1,6.75,6.75A6.758,6.758,0,0,1,2.75,9.5Z",displayName:"SearchIcon"}),ls="@open-pioneer/search",_e=Xe.bind(void 0,ls);function us(n){const e=n.selectProps.inputValue.length>0,t={...n,className:Ee(n.className,{"search-invisible":!e})};return y.jsx(k.Menu,{...t,children:n.children})}function hs(n){const e=n.data.label,t={...n.innerProps,"aria-label":e,role:"group"};return y.jsx(k.Group,{...n,innerProps:t})}function ds(n){const t=_e().formatMessage({id:"noOptionsText"});return y.jsx(k.NoOptionsMessage,{...n,children:y.jsx(re.span,{className:"search-no-match",children:t})})}function gs(n){const t=_e().formatMessage({id:"loadingText"});return y.jsx(k.LoadingMessage,{...n,children:y.jsx(re.span,{className:"search-loading-text",children:t})})}function fs({children:n,...e}){const t={...e,className:Ee(e.className,"search-value-container")};return y.jsxs(k.ValueContainer,{...t,children:[!!n&&y.jsx(cs,{style:{position:"absolute",left:8}}),n]})}function _s(n){const e={...n,isHidden:!1};return y.jsx(k.Input,{...e})}function ms(n){return null}function ys(n){return y.jsxs(k.IndicatorsContainer,{...n,children:[n.children,!n.selectProps.isLoading&&n.selectProps.inputValue&&y.jsx(ps,{selectProps:n.selectProps,clearValue:n.clearValue})]})}function ps(n){const t=_e().formatMessage({id:"ariaLabel.clearButton"}),s=i=>{i.preventDefault(),i.stopPropagation(),n.clearValue()};return y.jsx(Gt,{role:"button",size:"md",mr:1,"aria-label":t,onClick:s,onTouchEnd:s,onMouseDown:i=>i.preventDefault()})}function vs(n){return null}function Ss(n){const e=n.selectProps.inputValue,t=n.data.label,s={...n,className:Ee(n.className,"search-option")};return y.jsx(k.Option,{...s,children:y.jsx(re.div,{className:"search-option-label",children:e.trim().length>0?xs(t,e):t})})}function xs(n,e){const t=n.toLowerCase().indexOf(e.toLowerCase());return t>=0?y.jsxs(y.Fragment,{children:[n.substring(0,t),y.jsx(re.span,{className:"search-highlighted-match",children:n.substring(t,t+e.length)},"highlighted"),n.substring(t+e.length)]}):n}const He=fe("search:SearchController"),$e=200,qe=5;var Z,N,B,U,T,de,ut;class ws{constructor(e,t){v(this,de);v(this,Z);v(this,N,[]);v(this,B,qe);v(this,U,$e);v(this,T);x(this,Z,e),x(this,N,t)}destroy(){_(this,T)?.abort(),x(this,T,void 0)}async search(e){if(_(this,T)?.abort(),x(this,T,void 0),!e)return[];const t=x(this,T,new AbortController);try{return await bs(t.signal,_(this,U)),t.signal.aborted&&(He.debug(`search canceled with ${e}`),jt()),(await Promise.all(_(this,N).map(i=>$(this,de,ut).call(this,i,e,t.signal)))).filter(i=>i!=null)}finally{_(this,T)===t&&x(this,T,void 0)}}get searchTypingDelay(){return _(this,U)}set searchTypingDelay(e){x(this,U,e??$e)}get maxResultsPerSource(){return _(this,B)}set maxResultsPerSource(e){x(this,B,e??qe)}get sources(){return _(this,N)}}Z=new WeakMap,N=new WeakMap,B=new WeakMap,U=new WeakMap,T=new WeakMap,de=new WeakSet,ut=async function(e,t,s){const i=e.label,r=_(this,Z).olMap.getView().getProjection();try{const a=_(this,B);let o=await e.search(t,{maxResults:a,signal:s,mapProjection:r});return o.length>a&&(o=o.slice(0,a)),{label:i,source:e,results:o}}catch(a){tt(a)||He.error(`search for source ${i} failed`,a);return}};async function bs(n,e){n.aborted||await new Promise(t=>{const s=()=>{n.removeEventListener("abort",s),clearTimeout(i),t()};n.addEventListener("abort",s);const i=setTimeout(s,e)})}const he=fe("search:Search"),ri=n=>{const{sources:e,searchTypingDelay:t,maxResultsPerGroup:s,onSelect:i,onClear:r}=n,{containerProps:a}=Ze("search",n),{map:o}=Qe(n),c=_e(),u=Ms(e,t,s,o),{input:l,search:g,selectedOption:h,onInputChanged:d,onResultConfirmed:m}=Ls(u),w=Fs(),M=Cs(c),R=Es(),O=H((C,ne)=>{ne.action==="input-change"&&d(C)}),S=H((C,ne)=>{switch(ne.action){case"select-option":C&&(m(C),i?.({source:C.source,result:C.result}));break;case"clear":d(""),b.current?.blur(),b.current?.focus(),r?.();break;default:he.debug(`Unhandled action type '${ne.action}'.`);break}}),b=p.useRef(null);return y.jsx(st,{...a,children:y.jsx(ot,{className:"search-component",classNamePrefix:"react-select",ref:b,inputValue:l,onInputChange:O,"aria-label":c.formatMessage({id:"ariaLabel.search"}),ariaLiveMessages:M,tagColorScheme:"trails",selectedOptionStyle:"color",selectedOptionColorScheme:"trails",chakraStyles:w,isClearable:!0,placeholder:n.placeholder??c.formatMessage({id:"searchPlaceholder"}),closeMenuOnSelect:!0,isLoading:g.kind==="loading",options:g.kind==="ready"?g.results:void 0,filterOption:()=>!0,tabSelectsValue:!1,components:R,onChange:S,value:h,menuPosition:"fixed"})})};function Cs(n){return p.useMemo(()=>({onFocus:()=>"",onChange:()=>"",guidance:()=>`${n.formatMessage({id:"ariaLabel.instructions"})}`,onFilter:()=>""}),[n])}function Es(){return p.useMemo(()=>({Menu:us,Input:_s,SingleValue:ms,Option:Ss,NoOptionsMessage:ds,LoadingMessage:gs,ValueContainer:fs,IndicatorsContainer:ys,ClearIndicator:vs,Group:hs}),[])}function Fs(){const[n,e,t]=it("colors",["trails.100","trails.50","trails.500"],["#d5e5ec","#eaf2f5","#1A202C"]);return p.useMemo(()=>({groupHeading:i=>({...i,backgroundColor:n,padding:"8px 12px",fontSize:"inherit",fontWeight:"inherit"}),option:i=>({...i,backgroundColor:"inherit",_focus:{backgroundColor:e},_selected:{backgroundColor:t}}),dropdownIndicator:i=>({...i,display:"none"})}),[n,e,t])}function Ms(n,e,t,s){const[i,r]=p.useState(void 0);return p.useEffect(()=>{if(!s)return;const a=new ws(s,n);return r(a),()=>{a.destroy(),r(void 0)}},[s,n]),p.useEffect(()=>{i&&(i.searchTypingDelay=e)},[i,e]),p.useEffect(()=>{i&&(i.maxResultsPerSource=t)},[i,t]),i}function Ls(n){const[e,t]=p.useReducer((o,c)=>{switch(c.kind){case"input":return{...o,query:c.query,selectedOption:null};case"select-option":return{...o,selectedOption:c.option,query:c.option.label};case"load-results":return{...o,search:{kind:"loading"}};case"accept-results":return{...o,search:{kind:"ready",results:c.results}}}},void 0,()=>({query:"",selectedOption:null,search:{kind:"ready",results:[]}})),s=p.useRef(),i=H(o=>{if(!n){s.current=void 0,t({kind:"accept-results",results:[]});return}he.isDebug()&&he.debug(`Starting new search for query ${JSON.stringify(o)}.`),t({kind:"load-results"});const c=s.current=Ps(n,o).then(u=>{s.current===c&&t({kind:"accept-results",results:u})})}),r=p.useCallback(o=>{t({kind:"select-option",option:o})},[]),a=p.useCallback(o=>{t({kind:"input",query:o}),i(o)},[i]);return{input:e.query,search:e.search,selectedOption:e.selectedOption,onResultConfirmed:r,onInputChanged:a}}async function Ps(n,e){let t;try{t=await n.search(e)}catch(s){tt(s)||he.error("Search failed",s),t=[]}return Is(t)}function Is(n){return n.map((t,s)=>({label:t.label,options:t.results.map(i=>({value:`${s}-${i.id}`,label:i.label,source:t.source,result:i}))}))}const ht="@open-pioneer/selection",Ts=Dt.bind(void 0,ht),Fe=Xe.bind(void 0,ht),q="selection-active",ce="selection-inactive";class ks{tooltip;interactionResources=[];olMap;isActive=!0;tooltipMessage;tooltipDisabledMessage;constructor(e,t,s,i){const r=this.initViewport(e);this.interactionResources.push(this.createDragBox(e,i,r,this.interactionResources)),this.interactionResources.push(this.createDrag(e,r,this.interactionResources)),this.tooltip=this.createHelpTooltip(e,t),this.olMap=e,this.tooltipMessage=t,this.tooltipDisabledMessage=s}initViewport(e){const t=e.getViewport();return t.classList.add(q),t.oncontextmenu=s=>(s.preventDefault(),!1),t}destroy(){this.tooltip.destroy(),this.interactionResources.forEach(e=>{e.destroy()})}setActive(e){if(this.isActive===e)return;const t=this.olMap.getViewport();e?(this.interactionResources.forEach(s=>this.olMap.addInteraction(s.interaction)),this.tooltip.setText(this.tooltipMessage),t.classList.remove(ce),t.classList.add(q),this.isActive=!0):(this.interactionResources.forEach(s=>this.olMap.removeInteraction(s.interaction)),this.tooltip.setText(this.tooltipDisabledMessage),t.classList.remove(q),t.classList.add(ce),this.isActive=!1)}createDragBox(e,t,s,i){const r=new De({className:"selection-drag-box",condition:Rt});return e.addInteraction(r),r.on("boxend",function(){t(r.getGeometry())}),{interaction:r,destroy(){e.removeInteraction(r),i.splice(i.indexOf(this)),r.dispose(),s.classList.remove(q),s.classList.remove(ce),s.oncontextmenu=null}}}createDrag(e,t,s){const i=function(o){return o.originalEvent.button==2},r=new Re({condition:i});return e.addInteraction(r),{interaction:r,destroy(){e.removeInteraction(r),s.splice(s.indexOf(this)),r.dispose(),t.classList.remove(q),t.classList.remove(ce),t.oncontextmenu=null}}}createHelpTooltip(e,t){const s=document.createElement("div");s.className="selection-tooltip printing-hide",s.role="tooltip";const i=document.createElement("span");i.textContent=t,s.appendChild(i);const r=new nt({element:s,offset:[15,0],positioning:"center-left"}),a=e.on("pointermove",o=>{r.setPosition(o.coordinate)});return e.addOverlay(r),{overlay:r,element:s,destroy(){e.removeOverlay(r),r.dispose(),ie(a)},setText(o){i.textContent=o}}}getDragboxInteraction(){return this.interactionResources.find(e=>e.interaction instanceof De)}getDragPanInteraction(){return this.interactionResources.find(e=>e.interaction instanceof Re)}}const Se=fe("selection:SelectionController"),As=1e4;var Q,ee,te,ge,dt;class Os{constructor(e){v(this,ge);v(this,Q);v(this,ee);v(this,te);const{mapModel:t,onError:s,maxResults:i=As}=e;x(this,Q,t),x(this,ee,i),x(this,te,s)}destroy(){}async select(e,t){if(t)return await $(this,ge,dt).call(this,e,t)}}Q=new WeakMap,ee=new WeakMap,te=new WeakMap,ge=new WeakSet,dt=async function(e,t){const s=_(this,Q).olMap.getView().getProjection();try{Se.debug(`Starting selection on source '${e.label}'`);const i=_(this,ee);let r=await e.select({type:"extent",extent:t},{maxResults:i,mapProjection:s,signal:new AbortController().signal});return r.length>i&&(r=r.slice(0,i)),Se.debug(`Found ${r.length} results on source '${e.label}'`),{source:e,results:r}}catch(i){Se.error(`selection from source ${e.label} failed`,i),_(this,te).call(this);return}};const Ds={classNamePrefix:"react-select",menuPosition:"fixed",isSearchable:!1,isClearable:!1},ni=n=>{const e=Fe(),{sources:t,onSelectionComplete:s,onSelectionSourceChanged:i}=n,{containerProps:r}=Ze("selection",n),a=e.formatMessage({id:"sourceNotAvailable"}),[o,c]=js(t,i),u=_t(o,a),l=Qe(n),{onExtentSelected:g}=Vs(l.map,t,o,s),h=Bs(),[d,m]=p.useState(!1);Ns(l.map,e,g,u.kind==="available",!!o);const w=p.useMemo(()=>t.map(S=>({label:S.label,value:S})),[t]),M=p.useMemo(()=>w.find(b=>b.value===o)||null,[w,o]),R=H(S=>{c(S?.value)}),O=H(S=>{!d&&S.key==="Enter"&&m(!0)});return y.jsx(Vt,{...r,spacing:2,children:y.jsxs(zt,{children:[y.jsx(Jt,{children:e.formatMessage({id:"selectSource"})}),y.jsx(ot,{className:"selection-source react-select",...Ds,options:w,placeholder:e.formatMessage({id:"selectionPlaceholder"}),value:M,onChange:R,components:{Option:Rs,SingleValue:Gs},isOptionDisabled:()=>!1,getOptionLabel:S=>{const b=S.label,C=ft(S.value,a);return C.kind=="available"?b:b+" "+C.reason},ariaLiveMessages:{guidance:()=>"",onChange:S=>S.action=="select-option"||S.action=="initial-input-focus"?S.label+" "+e.formatMessage({id:"selected"}):"",onFilter:()=>"",onFocus:()=>""},chakraStyles:h,onKeyDown:O,menuIsOpen:d,onMenuOpen:()=>m(!0),onMenuClose:()=>m(!1)})]})})};function Rs(n){const{value:e}=n.data,{isAvailable:t,content:s}=gt(e,!1);return y.jsx(k.Option,{...n,isDisabled:!t,className:"selection-source-option",children:s})}function Gs(n){const{value:e}=n.data,{isAvailable:t,content:s}=gt(e,!0),i=t?"selection-source-value":"selection-source-value selection-source-value--disabled";return y.jsx(k.SingleValue,{...n,isDisabled:!t,className:i,children:s})}function js(n,e){const[t,s]=p.useState(()=>n[0]);p.useEffect(()=>{t&&!n.includes(t)&&s(void 0)},[n,t]);const i=p.useRef(void 0);return p.useEffect(()=>{t!==i.current&&(i.current=t,e?.({source:t}))},[t,e]),[t,s]}function gt(n,e){const t=Fe(),s=n?.label,i=t.formatMessage({id:"sourceNotAvailable"}),r=_t(n,i);return{isAvailable:r.kind==="available",content:y.jsxs(Ge,{direction:"row",alignItems:"center",grow:1,children:[!e&&y.jsx(Ge,{grow:1,children:s}),r.kind==="unavailable"&&y.jsx(st,{ml:2,children:y.jsx(Nt,{label:r.reason,placement:"right",openDelay:500,children:y.jsx(re.span,{children:y.jsx(Bt,{as:Wt,color:"red",className:"warning-icon","aria-label":r.reason})})})}),e&&s]})}}function Vs(n,e,t,s){const i=Ts("notifier.NotificationService"),r=Fe(),[a,o]=p.useState(void 0);p.useEffect(()=>{if(!n)return;const u=new Os({mapModel:n,onError(){i.notify({level:"error",message:r.formatMessage({id:"selectionFailed"})})}});return o(u),()=>{u.destroy()}},[n,i,e,r]);const c=H(async u=>{if(!a||!t)return;const l=await a.select(t,u.getExtent());l&&s?.(l)});return{controller:a,onExtentSelected:c}}function ft(n,e){const t=n.status??"available",s=typeof t=="string"?{kind:t}:t;return s.kind==="available"?s:{kind:"unavailable",reason:s.reason??e}}function _t(n,e){return $t(()=>n?ft(n,e):{kind:"unavailable",reason:e},[n,e])}function Ns(n,e,t,s,i){p.useEffect(()=>{if(!n)return;const r=i?e.formatMessage({id:"disabledTooltip"}):e.formatMessage({id:"noSourceTooltip"}),a=new ks(n.olMap,e.formatMessage({id:"tooltip"}),r,t);return a.setActive(s),()=>{a?.destroy()}},[n,e,t,s,i])}function Bs(){const[n,e]=it("colors",["background_body","border"],["#ffffff","#ffffff"]);return p.useMemo(()=>({control:s=>({...s,cursor:"pointer"}),indicatorSeparator:s=>({...s,borderColor:e}),dropdownIndicator:s=>({...s,backgroundColor:n})}),[n,e])}export{si as E,at as S,ii as V,ti as W,ri as a,ni as b};
