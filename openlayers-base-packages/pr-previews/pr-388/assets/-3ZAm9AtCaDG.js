var re=Object.defineProperty;var B=t=>{throw TypeError(t)};var se=(t,e,r)=>e in t?re(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var R=(t,e,r)=>se(t,typeof e!="symbol"?e+"":e,r),O=(t,e,r)=>e.has(t)||B("Cannot "+r);var h=(t,e,r)=>(O(t,e,"read from private field"),r?r.call(t):e.get(t)),y=(t,e,r)=>e.has(t)?B("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),S=(t,e,r,s)=>(O(t,e,"write to private field"),s?s.call(t,r):e.set(t,r),r),x=(t,e,r)=>(O(t,e,"access private method"),r);import{c as oe,i as H,r as v,j as m}from"./CilY7FyO6Rl3.js";import{G as T}from"./qJ8eJhSfJf-T.js";import{b as ae,az as ne,bx as ie,u as ce,aZ as z,i as Z,by as G,e as ue,r as le,j as fe,V as de}from"./CSmiKdizJP8d.js";import{T as D}from"./DWSYd4wJ1TYc.js";import{a as he,b as me,c as we,d as ge,e as be}from"./n4hly-pWbHU_.js";import{u as pe}from"./BijvRNQYcfni.js";const ve="next";function ye(t,e,r,s){const o=new URL(t),a=o.searchParams;return a.set("bbox",e.join(",")),a.set("bbox-crs",r),a.set("crs",r),a.set("f","json"),s?.(new URL(o))??o}function xe(t,e,r){const s=new URL(t),o=s.searchParams;return o.set("offset",e.toString()),o.set("limit",r.toString()),s.toString()}function K(t){if(!Array.isArray(t))return;const r=t.filter(s=>s.rel===ve);if(r.length===1)return r[0]?.href}async function J(t,e,r,s){let o=[];const a={headers:{Accept:"application/geo+json"},signal:s},n=await r.fetch(t,a);if(n.status!==200)throw new Error(`Failed to query features from service (status code ${n.status})`);const i=await n.json();e&&(o=e.readFeatures(i));const c=K(i.links);return{features:o,numberMatched:i.numberMatched,nextURL:c}}async function Re(t,e){const r={supportsOffsetStrategy:!1},s=new URL(t);s.searchParams.set("limit","1"),s.searchParams.set("f","json");const o=await e.fetch(s.toString(),{headers:{Accept:"application/geo+json"}});if(o.status!==200)throw new Error(`Failed to probe collection information (status code ${o.status})`);const a=await o.json(),n=K(a.links);if(!n)return r;const c=new URL(n).searchParams.has("offset");return r.supportsOffsetStrategy=c,r}async function Fe(t){const{fullURL:e,featureFormat:r,signal:s,addFeatures:o,queryFeatures:a}=t,n=t.limit,i=t.maxConcurrentRequests;let c=0,l=e;const f=[];let u;for(;l;){let b;u==null?b=i:b=Math.ceil((u-c)/n),b=Math.max(1,Math.min(b,i));const F=[];for(let d=0;d<b;++d)F.push(xe(e,c,n)),c+=n;const w=await W(F,r,t.httpService,s,o,a);f.push(...w.features),l=w.nextURL,w.numberMatched!=null&&(u=w.numberMatched)}return f}const U=oe("ogc-features:OgcFeatureSourceFactory"),Le=5e3,Se=6;function Ie(t,e){return Ue(t,{httpService:e})}function Ue(t,e){const r=e.httpService,s=`${t.baseUrl}/collections/${t.collectionId}/items?`,o=new ae({format:new T,strategy:ne,attributions:t.attributions,...t.additionalOptions}),a=e.queryFeaturesParam??J,n=e.getCollectionInfosParam??Re,i=e.addFeaturesParam||function(u){U.debug(`Adding ${u.length} features`),o.addFeatures(u)};let c,l;const f=async(u,b,F,w,d)=>{l??=n(s,r);let I;try{I=await l}catch(L){U.error("Failed to retrieve collection information",L),d?.(),l=void 0;return}c?.abort("Extent changed"),c=new AbortController;const N=ye(s,u,t.crs,t.rewriteUrl);let A=t?.strategy||(I?.supportsOffsetStrategy?"offset":"next");A==="offset"&&!I?.supportsOffsetStrategy&&(A="next");try{const L=await Pe(A,{fullURL:N.toString(),httpService:r,featureFormat:o.getFormat(),queryFeatures:a,addFeatures:i,limit:t.limit??Le,maxConcurrentRequests:t.maxConcurrentRequests??Se,signal:c.signal,collectionInfos:I});w?.(L),U.debug("Finished loading features for extent:",u)}catch(L){H(L)?(U.debug("Query-Feature-Request aborted",L),o.removeLoadedExtent(u),d?.()):U.error("Failed to load features",L)}};return o.setLoader(f),o}function Pe(t,e){switch(t){case"next":return Me(e);case"offset":return Fe(e)}}async function Me(t){const e=t.limit;let r=new URL(t.fullURL);r.searchParams.set("limit",e.toString());let s=[];do{const o=await W([r.toString()],t.featureFormat,t.httpService,t.signal,t.addFeatures,t.queryFeatures);if(s=s.concat(o.features),!o.nextURL)break;r=new URL(o.nextURL)}while(!0);return s}async function W(t,e,r,s,o,a=J){const n={nextURL:void 0,numberMatched:void 0,features:[]},i=t.map(async(c,l)=>{const f=l===t.length-1,u=await a(c,e,r,s);o(u.features),U.debug(`NextURL for index = ${l} (isLast = ${f}): ${u.nextURL||"No Next URL"}`),n.features.push(...u.features),f&&(n.numberMatched=u.numberMatched,n.nextURL=u.nextURL)});return await Promise.all(i),n}var p,M,V,C,P,X,Q;class Ve{constructor(e,r){y(this,P);R(this,"label");y(this,p);y(this,M);y(this,V);y(this,C);this.label=e.label,S(this,p,e),S(this,M,r);const{baseUrl:s,params:o}=je(e.baseUrl);S(this,V,s),S(this,C,o)}async search(e,{mapProjection:r,maxResults:s,signal:o}){const a=x(this,P,Q).call(this,e,s),n=new T({dataProjection:"EPSG:4326",featureProjection:r});return(await Ce(h(this,M),a,o)).features.map(c=>x(this,P,X).call(this,c,n))}}p=new WeakMap,M=new WeakMap,V=new WeakMap,C=new WeakMap,P=new WeakSet,X=function(e,r){const s=h(this,p).renderLabel?.(e),o=e.properties[h(this,p).labelProperty],a=e.properties[h(this,p).searchProperty],n=s||(o!==void 0?String(o):a!==void 0?String(a):"");return{id:e.id??ie(),label:n,geometry:r.readGeometry(e.geometry),properties:e.properties}},Q=function(e,r){const s=new URL(`${h(this,V)}/collections/${h(this,p).collectionId}/items`);for(const[o,a]of h(this,C))s.searchParams.append(o,a);return s.searchParams.set(h(this,p).searchProperty,`*${e}*`),s.searchParams.set("limit",String(r)),s.searchParams.set("f","json"),h(this,p).rewriteUrl?.(new URL(s))??s};async function Ce(t,e,r){try{const s=await t.fetch(e,{signal:r,headers:{Accept:"application/json"}});if(!s.ok)throw new Error("Request failed with status "+s.status);return await s.json()}catch(s){throw H(s)?s:new Error("Failed to search on OGC API Features service",{cause:s})}}function je(t){const e=new URL(t),r=new URLSearchParams(e.searchParams);return e.search="",{baseUrl:e.href.replace(/\/+$/,""),params:r}}var j;class Te{constructor({references:e}){y(this,j);S(this,j,e.httpService)}createVectorSource(e){return Ie(e,h(this,j))}}j=new WeakMap;var E;class Ge{constructor({references:e}){y(this,E);S(this,E,e.httpService)}createSearchSource(e){return new Ve(e,h(this,E))}}E=new WeakMap;const Ee="@open-pioneer/map-navigation",$=ce.bind(void 0,Ee),Ke=v.forwardRef(function(e,r){const{containerProps:s}=z("initial-extent",e),{map:o}=Z(e),a=$(),{buttonProps:n}=e;function i(){const c=o?.initialExtent;if(c){const l=[c.xMin,c.yMin,c.xMax,c.yMax];o.olView.fit(l,{duration:200})}}return m.jsx(D,{ref:r,buttonProps:n,label:a.formatMessage({id:"initial-extent.title"}),icon:m.jsx(he,{}),onClick:i,...s})}),Je=v.forwardRef(function(e,r){return m.jsx(Y,{zoomDirection:"in",ref:r,...e})}),We=v.forwardRef(function(e,r){return m.jsx(Y,{zoomDirection:"out",ref:r,...e})}),Y=v.forwardRef(function(e,r){const{buttonProps:s,zoomDirection:o}=e,{map:a}=Z(e),n=$(),[i,c]=v.useState(!1),{defaultClassName:l,buttonLabel:f,buttonIcon:u}=ke(n,o),{containerProps:b}=z(G("zoom",l),e);function F(){if(i)return;c(!0);const w=a?.olView;let d=a?.zoomLevel;const I=w?.getMaxZoom()||Number.MAX_SAFE_INTEGER,N=w?.getMinZoom()||0;w&&d!==void 0&&(o==="in"&&d<I?++d:o==="out"&&d>N&&--d,w.animate({zoom:d,duration:200},()=>c(!1)))}return m.jsx(D,{ref:r,buttonProps:s,label:f,icon:u,onClick:F,...b})});function ke(t,e){switch(e){case"in":return{defaultClassName:"zoom-in",buttonLabel:t.formatMessage({id:"zoom-in.title"}),buttonIcon:m.jsx(we,{})};case"out":return{defaultClassName:"zoom-out",buttonLabel:t.formatMessage({id:"zoom-out.title"}),buttonIcon:m.jsx(me,{})}}}const Ne=200;var g,q,k,ee;class Ae{constructor(e){y(this,g);R(this,"olMap");R(this,"handle");R(this,"_mapViews",ue());R(this,"_activeViewId",le(0));R(this,"backward",()=>{if(this.canBackward)x(this,g,k).call(this,this.activeViewId-1),x(this,g,q).call(this,this.activeViewId);else throw new Error("Backward is not possible at the moment")});R(this,"forward",()=>{if(this.canForward)x(this,g,k).call(this,this.activeViewId+1),x(this,g,q).call(this,this.activeViewId);else throw new Error("Forward is not possible at the moment")});this.olMap=e.olMap,this.handle=x(this,g,ee).call(this)}destroy(){this.handle&&fe(this.handle),this.handle=void 0}get activeViewId(){return this._activeViewId.value}get mapViews(){return this._mapViews}get canBackward(){return this.mapViews.get(this.activeViewId-1)!=null}get canForward(){return this.mapViews.get(this.activeViewId+1)!=null}}g=new WeakSet,q=function(e){const r=this.olMap.getView();this.olMap.setView(new de({center:this.mapViews.get(e).center,resolution:this.mapViews.get(e).resolution,projection:r.getProjection()}))},k=function(e){this._activeViewId.value=e},ee=function(){const e=this.olMap.on("moveend",()=>{r()}),r=()=>{const s=this.olMap,o=this.mapViews,a=s.getView(),n=a.getResolution(),i=a.getCenter();if(n!=null&&i!=null&&(i!==o.get(this.activeViewId)?.center||n!==o.get(this.activeViewId)?.resolution)){const c={resolution:n,center:i},l=this.activeViewId+1;for(const f of o.keys())f>l&&o.delete(f);for(const f of o.keys()){if(o.size<Ne)break;o.delete(f)}x(this,g,k).call(this,l),o.set(l,c)}};return e};const _=new WeakMap;function Oe(t){const[e,r]=v.useState();return v.useEffect(()=>{if(!t)return;let s=_.get(t);return s==null?(s={vm:new Ae(t),useCount:1},_.set(t,s)):s.useCount++,r(s.vm),()=>{r(void 0),s.useCount--,s.useCount===0&&(s.vm.destroy(),_.delete(t))}},[t]),e}const Xe=v.forwardRef(function(e,r){return m.jsx(te,{viewDirection:"forward",ref:r,...e})}),Qe=v.forwardRef(function(e,r){return m.jsx(te,{viewDirection:"backward",ref:r,...e})}),te=v.forwardRef(function(e,r){const s=$(),{buttonProps:o,viewDirection:a}=e,{map:n}=Z(e),i=Oe(n),{defaultClassName:c,buttonLabel:l,buttonIcon:f}=_e(s,a),{containerProps:u}=z(G("view",c),e),b=pe(()=>i?a==="forward"?i.canForward:i.canBackward:!1,[i,a]),F=()=>{i&&(a==="forward"?i.forward():i.backward())};return i&&m.jsx(D,{ref:r,...u,buttonProps:o,label:l,icon:f,onClick:F,isDisabled:!b})});function _e(t,e){switch(e){case"forward":return{defaultClassName:"view-forward",buttonLabel:t.formatMessage({id:"view-forward.title"}),buttonIcon:m.jsx(be,{})};case"backward":return{defaultClassName:"view-backward",buttonLabel:t.formatMessage({id:"view-backward.title"}),buttonIcon:m.jsx(ge,{})}}}export{Qe as H,Ke as I,Ge as S,Te as V,Je as Z,We as a,Xe as b};
