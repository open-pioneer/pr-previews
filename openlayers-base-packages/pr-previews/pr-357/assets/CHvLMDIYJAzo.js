var X=Object.defineProperty;var N=t=>{throw TypeError(t)};var H=(t,e,r)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var q=(t,e,r)=>H(t,typeof e!="symbol"?e+"":e,r),A=(t,e,r)=>e.has(t)||N("Cannot "+r);var f=(t,e,r)=>(A(t,e,"read from private field"),r?r.call(t):e.get(t)),w=(t,e,r)=>e.has(t)?N("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),R=(t,e,r,s)=>(A(t,e,"write to private field"),s?s.call(t,r):e.set(t,r),r),O=(t,e,r)=>(A(t,e,"access private method"),r);import{c as Q,i as Z,r as P,j as F}from"./DnPhTJjuvB9x.js";import{G as z,T as $}from"./DDXpbECPx1AE.js";import{b as W,az as Y,b1 as ee,u as te,aZ as _,g as k,b4 as re}from"./CIxQfNC2cMTH.js";import{a as se,b as oe,c as ae}from"./CeFd-AnRDxaP.js";const ne="next";function ce(t,e,r,s){const o=new URL(t),a=o.searchParams;return a.set("bbox",e.join(",")),a.set("bbox-crs",r),a.set("crs",r),a.set("f","json"),s?.(new URL(o))??o}function ie(t,e,r){const s=new URL(t),o=s.searchParams;return o.set("offset",e.toString()),o.set("limit",r.toString()),s.toString()}function D(t){if(!Array.isArray(t))return;const r=t.filter(s=>s.rel===ne);if(r.length===1)return r[0]?.href}async function G(t,e,r,s){let o=[];const a={headers:{Accept:"application/geo+json"},signal:s},n=await r.fetch(t,a);if(n.status!==200)throw new Error(`Failed to query features from service (status code ${n.status})`);const u=await n.json();e&&(o=e.readFeatures(u));const c=D(u.links);return{features:o,numberMatched:u.numberMatched,nextURL:c}}async function ue(t,e){const r={supportsOffsetStrategy:!1},s=new URL(t);s.searchParams.set("limit","1"),s.searchParams.set("f","json");const o=await e.fetch(s.toString(),{headers:{Accept:"application/geo+json"}});if(o.status!==200)throw new Error(`Failed to probe collection information (status code ${o.status})`);const a=await o.json(),n=D(a.links);if(!n)return r;const c=new URL(n).searchParams.has("offset");return r.supportsOffsetStrategy=c,r}async function le(t){const{fullURL:e,featureFormat:r,signal:s,addFeatures:o,queryFeatures:a}=t,n=t.limit,u=t.maxConcurrentRequests;let c=0,l=e;const m=[];let i;for(;l;){let p;i==null?p=u:p=Math.ceil((i-c)/n),p=Math.max(1,Math.min(p,u));const S=[];for(let h=0;h<p;++h)S.push(ie(e,c,n)),c+=n;const b=await T(S,r,t.httpService,s,o,a);m.push(...b.features),l=b.nextURL,b.numberMatched!=null&&(i=b.numberMatched)}return m}const L=Q("ogc-features:OgcFeatureSourceFactory"),fe=5e3,me=6;function he(t,e){return de(t,{httpService:e})}function de(t,e){const r=e.httpService,s=`${t.baseUrl}/collections/${t.collectionId}/items?`,o=new W({format:new z,strategy:Y,attributions:t.attributions,...t.additionalOptions}),a=e.queryFeaturesParam??G,n=e.getCollectionInfosParam??ue,u=e.addFeaturesParam||function(i){L.debug(`Adding ${i.length} features`),o.addFeatures(i)};let c,l;const m=async(i,p,S,b,h)=>{l??=n(s,r);let d;try{d=await l}catch(x){L.error("Failed to retrieve collection information",x),h?.(),l=void 0;return}c?.abort("Extent changed"),c=new AbortController;const C=ce(s,i,t.crs,t.rewriteUrl);let y=t?.strategy||(d?.supportsOffsetStrategy?"offset":"next");y==="offset"&&!d?.supportsOffsetStrategy&&(y="next");try{const x=await ge(y,{fullURL:C.toString(),httpService:r,featureFormat:o.getFormat(),queryFeatures:a,addFeatures:u,limit:t.limit??fe,maxConcurrentRequests:t.maxConcurrentRequests??me,signal:c.signal,collectionInfos:d});b?.(x),L.debug("Finished loading features for extent:",i)}catch(x){Z(x)?(L.debug("Query-Feature-Request aborted",x),o.removeLoadedExtent(i),h?.()):L.error("Failed to load features",x)}};return o.setLoader(m),o}function ge(t,e){switch(t){case"next":return pe(e);case"offset":return le(e)}}async function pe(t){const e=t.limit;let r=new URL(t.fullURL);r.searchParams.set("limit",e.toString());let s=[];do{const o=await T([r.toString()],t.featureFormat,t.httpService,t.signal,t.addFeatures,t.queryFeatures);if(s=s.concat(o.features),!o.nextURL)break;r=new URL(o.nextURL)}while(!0);return s}async function T(t,e,r,s,o,a=G){const n={nextURL:void 0,numberMatched:void 0,features:[]},u=t.map(async(c,l)=>{const m=l===t.length-1,i=await a(c,e,r,s);o(i.features),L.debug(`NextURL for index = ${l} (isLast = ${m}): ${i.nextURL||"No Next URL"}`),n.features.push(...i.features),m&&(n.numberMatched=i.numberMatched,n.nextURL=i.nextURL)});return await Promise.all(u),n}var g,I,M,v,U,V,B;class be{constructor(e,r){w(this,U);q(this,"label");w(this,g);w(this,I);w(this,M);w(this,v);this.label=e.label,R(this,g,e),R(this,I,r);const{baseUrl:s,params:o}=xe(e.baseUrl);R(this,M,s),R(this,v,o)}async search(e,{mapProjection:r,maxResults:s,signal:o}){const a=O(this,U,B).call(this,e,s),n=new z({dataProjection:"EPSG:4326",featureProjection:r});return(await we(f(this,I),a,o)).features.map(c=>O(this,U,V).call(this,c,n))}}g=new WeakMap,I=new WeakMap,M=new WeakMap,v=new WeakMap,U=new WeakSet,V=function(e,r){const s=f(this,g).renderLabel?.(e),o=e.properties[f(this,g).labelProperty],a=e.properties[f(this,g).searchProperty],n=s||(o!==void 0?String(o):a!==void 0?String(a):"");return{id:e.id??ee(),label:n,geometry:r.readGeometry(e.geometry),properties:e.properties}},B=function(e,r){const s=new URL(`${f(this,M)}/collections/${f(this,g).collectionId}/items`);for(const[o,a]of f(this,v))s.searchParams.append(o,a);return s.searchParams.set(f(this,g).searchProperty,`*${e}*`),s.searchParams.set("limit",String(r)),s.searchParams.set("f","json"),f(this,g).rewriteUrl?.(new URL(s))??s};async function we(t,e,r){try{const s=await t.fetch(e,{signal:r,headers:{Accept:"application/json"}});if(!s.ok)throw new Error("Request failed with status "+s.status);return await s.json()}catch(s){throw Z(s)?s:new Error("Failed to search on OGC API Features service",{cause:s})}}function xe(t){const e=new URL(t),r=new URLSearchParams(e.searchParams);return e.search="",{baseUrl:e.href.replace(/\/+$/,""),params:r}}var E;class Ie{constructor({references:e}){w(this,E);R(this,E,e.httpService)}createVectorSource(e){return he(e,f(this,E))}}E=new WeakMap;var j;class Me{constructor({references:e}){w(this,j);R(this,j,e.httpService)}createSearchSource(e){return new be(e,f(this,j))}}j=new WeakMap;const Re="@open-pioneer/map-navigation",J=te.bind(void 0,Re),ve=P.forwardRef(function(e,r){const{mapId:s}=e,{containerProps:o}=_("initial-extent",e),{map:a}=k(s),n=J();function u(){const c=a?.initialExtent,l=a?.olMap;if(c&&l){const m=[c.xMin,c.yMin,c.xMax,c.yMax];l.getView().fit(m,{duration:200})}}return F.jsx($,{ref:r,label:n.formatMessage({id:"initial-extent.title"}),icon:F.jsx(se,{}),onClick:u,...o})}),Ee=P.forwardRef(function(e,r){return F.jsx(K,{zoomDirection:"in",ref:r,...e})}),je=P.forwardRef(function(e,r){return F.jsx(K,{zoomDirection:"out",ref:r,...e})}),K=P.forwardRef(function(e,r){const{mapId:s,zoomDirection:o,disableZoomBetweenAnimation:a}=e,{map:n}=k(s),u=J(),[c,l]=P.useState(!1),{defaultClassName:m,buttonLabel:i,buttonIcon:p}=Fe(u,o),{containerProps:S}=_(re("zoom",m),e);function b(){if(a&&c)return;l(!!a);const h=n?.olMap.getView();let d=h?.getZoom();const C=h?.getMaxZoom()||Number.MAX_SAFE_INTEGER,y=h?.getMinZoom()||0;h&&d!==void 0&&(o==="in"&&d<C?++d:o==="out"&&d>y&&--d,h.animate({zoom:d,duration:200},()=>l(!1)))}return F.jsx($,{isDisabled:c,ref:r,label:i,icon:p,onClick:b,...S})});function Fe(t,e){switch(e){case"in":return{defaultClassName:"zoom-in",buttonLabel:t.formatMessage({id:"zoom-in.title"}),buttonIcon:F.jsx(ae,{})};case"out":return{defaultClassName:"zoom-out",buttonLabel:t.formatMessage({id:"zoom-out.title"}),buttonIcon:F.jsx(oe,{})}}}export{ve as I,Me as S,Ie as V,Ee as Z,je as a};
